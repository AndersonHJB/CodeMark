__TEMPLATE__=editor
__LANG__=python
# -*- coding: utf-8 -*-
# @Time    : 2024/11/16 09:07
# @Author  : AIæ‚¦åˆ›
# @FileName: app.py
# @Software: CodeMark
# @Blog    ï¼šhttps://bornforthis.cn/
# æ¬¢è¿ğŸ‘ä½¿ç”¨ CodeMarkâœ¨âœ¨âœ¨
# æ­¤ç¼–è¾‘å™¨ä½ å¯ä»¥ç¼–è¾‘å’Œåˆ†äº«ä»£ç !
# PS:æ³¨é‡Šéƒ¨åˆ†ä½ å¯ä»¥ä¿ç•™æˆ–è€…åˆ é™¤
import requests
import re
import random

# é…ç½®
sitemap_url = "https://blog.bornforthis.cn/sitemap.xml"
# sitemap_url = "https://bornforthis.cn/sitemap.xml"
bing_api_url = "https://ssl.bing.com/webmaster/api.svc/json/SubmitUrlbatch"
apikey = "be37a86bb8624c28bb75eaba28c20cd6"  # æ›¿æ¢ä¸ºæ‚¨çš„å®é™… API å¯†é’¥
# site_url = "https://bornforthis.cn"
site_url = "https://blog.bornforthis.cn"
#
# æå– Sitemap ä¸­çš„é“¾æ¥
def fetch_sitemap_urls(sitemap_url):
    response = requests.get(sitemap_url)
    response.raise_for_status()  # ç¡®ä¿è¯·æ±‚æˆåŠŸ
    sitemap_content = response.text
    # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå– <loc> æ ‡ç­¾ä¸­çš„é“¾æ¥
    urls = re.findall(r"<loc>(.*?)</loc>", sitemap_content)
    return urls

# æäº¤é“¾æ¥åˆ° Bing API
def submit_urls_to_bing(api_url, apikey, site_url, url_list):
    headers = {
        "Content-Type": "application/json; charset=utf-8",
    }
    payload = {
        "siteUrl": site_url,
        "urlList": url_list
    }
    params = {
        "apikey": apikey
    }
    response = requests.post(api_url, headers=headers, params=params, json=payload)
    response.raise_for_status()  # ç¡®ä¿è¯·æ±‚æˆåŠŸ
    return response.json()

# ä¸»ç¨‹åº
def main():
    try:
        print("Fetching URLs from sitemap...")
        urls = fetch_sitemap_urls(sitemap_url)
        print(f"Fetched {len(urls)} URLs.")

        # éšæœºæ‰“ä¹±é“¾æ¥é¡ºåº
        print("Shuffling URLs...")
        random.shuffle(urls)

        # å°† URLs åˆ†æ‰¹æäº¤ï¼Œé¿å…è¶…å‡º API é™åˆ¶
        batch_size = 100  # æ¯æ‰¹æäº¤çš„é“¾æ¥æ•°é‡
        for i in range(0, len(urls), batch_size):
            batch = urls[i:i + batch_size]
            print(f"Submitting batch {i // batch_size + 1} with {len(batch)} URLs...")
            response = submit_urls_to_bing(bing_api_url, apikey, site_url, batch)
            print(f"Batch {i // batch_size + 1} submitted successfully: {response}")
    except Exception as e:
        print(f"An error occurred: {e}")

if __name__ == "__main__":
    main()
