<!DOCTYPE html>
<html lang="en">
<head>
    <title>Pythonåœ¨çº¿ä»£ç ç¼–å†™ï½œAIæ‚¦åˆ›ç¼–ç¨‹ä¸€å¯¹ä¸€è¾…å¯¼</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta property="og:site_name" content="Pythonåœ¨çº¿ä»£ç ç¼–å†™ï½œAIæ‚¦åˆ›ç¼–ç¨‹ä¸€å¯¹ä¸€è¾…å¯¼">
    <link rel="icon" href="https://bornforthis.cn/favicon.ico">
    <meta property="og:locale" content="zh-CN">
    <meta name="keywords"
          content="ä»£ç , ä»£ç åˆ†äº«, åœ¨çº¿å·¥å…·, åˆ›å®¢, AIæ‚¦åˆ›, Python, Java, C++, code share, program share, ç¼–ç¨‹ä¸€å¯¹ä¸€æ•™å­¦, Javaç¼–ç¨‹ä¸€å¯¹ä¸€æ•™å­¦">
    <meta name="description"
          content="ä¸€ä¸ªæ–¹ä¾¿ä¸ç”¨å®‰è£…ç¯å¢ƒï¼Œå¯ä»¥æµè§ˆå™¨ç¼–å†™ä»£ç å’Œåˆ†äº«ä»£ç çš„åœ¨çº¿å°å·¥å…·ï¼Œè¿˜å¯ä»¥ç”Ÿæˆå¸¦äºŒç»´ç çš„ä»£ç æˆªå›¾ï¼Œæ–¹ä¾¿åˆ†äº«ã€‚">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.18/dist/css/bootstrap-select.min.css"
          rel="stylesheet">
    <style type="text/css" media="screen">
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #2f3129;
            overflow: hidden;
        }

        .container-fluid {
            margin: 0;
            padding: 0;
        }

        /* 2. è®© row ä½¿ç”¨ no-guttersï¼Œå»æ‰é»˜è®¤çš„å·¦å³å†…é—´è· */
        .row.no-gutters {
            margin-right: 0;
            margin-left: 0;
        }

        /* ä¹Ÿå¯å†è¦†ç›– col é»˜è®¤çš„padding */
        .col-sm-8, .col-md-4 {
            padding: 0 !important;
        }

        .ace_editor .ace_content span,
        .ace_editor .ace_content .ace_line {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace !important;
        }

        img {
            max-width: 100%;
        }

        .btn-area {
            height: 56px;
            background-color: #2f3129;
        }

        .btn-area button {
            float: left;
            color: #fff;
            border-radius: 0;
            border-width: 0;
            height: 100%;
            width: 80px;
            transition: transform 0.2s;
        }

        .btn-area button:hover {
            transform: scale(1.05);
        }

        #run {
            float: left;
            background-color: #a7c336;
            color: #fff;
            border-radius: 0;
            border-width: 0;
            height: 100%;
            width: 80px;
        }

        #save {
            background-color: #6dddf2;
        }

        #open {
            background-color: #f53855;
        }

        #share {
            background-color: #a7c336;
        }

        #home {
            background-color: #ef7d62;
        }

        .help-link-container a {
            color: #fff;
        }

        .choose-container {
            color: #fff;
            padding-left: 5px;
            padding-right: 5px;
            display: flex;
            display: -webkit-flex;
            align-items: center;
        }

        .theme-choose {
            color: #fff;
            padding-left: 5px;
            padding-right: 5px;
            display: flex;
            display: -webkit-flex;
            align-items: center;
        }

        .code-container {
            padding-left: 0;
            padding-right: 0;
            /* è®©ç¼–è¾‘å™¨æ‰€åœ¨åˆ—å¯ä¼¸ç¼©ï¼Œå æ»¡å‰©ä½™ç©ºé—´ */
            height: calc(100vh - 56px);
            overflow: hidden;
        }

        #editor {
            /* è®© Ace Editor å æ»¡çˆ¶å®¹å™¨çš„é«˜åº¦ */
            height: 100%;
            width: 100%;
        }

        .console {
            width: 100%;
            height: calc(100vh - 56px);
            background-color: #000;
            color: #FFF;
            font-size: 20px;
            font-weight: 700;
            border-width: 0;
            font-family: 'Monaco', 'Consolas', serif;
            padding: 8px 8px;
            white-space: pre;
            overflow-x: auto;
            overflow-y: auto;
            resize: none;
        }

        .modal-dialog {
            margin: 0.5rem auto; /* ä¸Šä¸‹å¾®è·ï¼Œå·¦å³å±…ä¸­ */
            max-width: 70%;      /* é»˜è®¤å¤§å±æ—¶çš„æœ€å¤§å®½åº¦ */
            width: auto;
        }

        /* å¼¹çª—å†…å®¹å¦‚æœè¶…å‡ºä¸€å®šé«˜åº¦ï¼Œäº§ç”Ÿæ»šåŠ¨æ¡ï¼Œä»¥é˜²åœ¨å°å±æ—¶æ’‘å‡ºå±å¹• */
        .modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }

        /* é’ˆå¯¹å°å±å¹•åšè‡ªé€‚åº”ï¼Œè®©å¼¹çª—æ›´å¤§ï¼Œå‡ ä¹å…¨å± */
        @media (max-width: 768px) {
            .modal-dialog {
                max-width: 95% !important;
                margin: 1rem auto;
            }
        }

        /* Add custom styles for bootstrap-select in dark theme */
        .bootstrap-select .dropdown-toggle {
            background-color: #4a4a4a;
            border-color: #666;
            color: white;
        }

        .bootstrap-select .dropdown-toggle:hover {
            background-color: #5a5a5a;
        }

        /* ====== å¤åˆ¶æˆåŠŸæç¤ºçš„åŠ¨ç”»æ ·å¼ ====== */
        .copy-success {
            display: none;
            color: #28a745;
            font-weight: bold;
            margin-top: 10px;
            /* ç®€å•çš„æ¸å…¥æ¸å‡ºåŠ¨ç”» */
            animation: fadeInOut 2s forwards;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                opacity: 0;
            }
        }

        /* ========== è‡ªå®šä¹‰å³é”®èœå•æ ·å¼ ========== */
        #custom-context-menu {
            position: absolute;
            z-index: 9999;
            background-color: #3c3c3c; /* ç¨å¾®æ¯”é¡µé¢åº•è‰²æ·±ä¸€äº› */
            border: 1px solid #4f4f4f;
            border-radius: 5px;
            min-width: 180px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            display: none;
        }

        #custom-context-menu ul {
            list-style: none;
            margin: 0;
            padding: 6px 0;
        }

        #custom-context-menu li {
            padding: 8px 12px;
            cursor: pointer;
            color: #ffffff;
            font-size: 14px;
        }

        #custom-context-menu li:hover {
            background-color: #575757;
        }
    </style>

    <!-- å¦‚æœåç«¯ä¼ æ¥äº† pre_codeï¼Œå°±ç”¨å®ƒæ¥è®¾ç½®ç¼–è¾‘å™¨åˆå§‹å€¼ã€‚å¦åˆ™ä¸ºç©ºä¸² -->
    {% if pre_code %}
        <script>
            let server_pre_code = {{ pre_code|tojson }};
        </script>
    {% else %}
        <script>
            let server_pre_code = "";
        </script>
    {% endif %}
</head>

<body>
<div class="container-fluid">
    <div class="row">
        <!-- ä»£ç ç¼–è¾‘åŒº -->
        <div class="col-sm-8 code-container">
            <div id="editor"></div>
        </div>
        <!-- æ§åˆ¶å°è¾“å‡ºåŒº -->
        <div class="col-md-4 pl-0 pr-0">
            <textarea id="console" class="console" autocomplete="off">Initializing Pyodide...</textarea>
        </div>
    </div>

    <!-- æŒ‰é’®åŒºåŸŸ -->
    <div class="row btn-area">
        <button id="run" onclick="run()">> run</button>
        <button id="save" onclick="save()">save</button>
        <button id="open" onclick="performClick('file-input')">open</button>
        <button id="share" onclick="share()">share</button>
        <button id="home" onclick="home()">home</button>
        <div class="choose-container theme-selector-container">
            <span class="ml-2 mr-2">Theme: </span>
            <select id="theme-selector" class="selectpicker" data-style="btn-dark" data-width="120px">
                <option value="monokai">monokai</option>
                <option value="github">github</option>
                <option value="tomorrow">tomorrow</option>
                <option value="kuroir">kuroir</option>
                <option value="twilight">twilight</option>
                <option value="vibrant_ink">vibrant_ink</option>
                <option value="xcode">xcode</option>
                <option value="textmate">textmate</option>
                <option value="terminal">terminal</option>
                <option value="solarized_dark">solarized dark</option>
                <option value="solarized_light">solarized light</option>
            </select>
        </div>
        <div class="help-link-container my-auto ml-3">
            <a id="about" href="#" data-toggle="modal" data-target="#about-modal">About</a>
        </div>
        <input id="file-input" type="file" style="position:fixed;top:-1000px;"/>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="share-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Share your code</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <!-- è¿™é‡Œä¼šåŠ¨æ€ç”ŸæˆäºŒç»´ç +æœ€ç»ˆåˆæˆå›¾ -->
                <div id="qrcode" style="margin-left:auto; margin-right:auto; margin-bottom: 20px;"></div>
                <!-- æ˜¾ç¤ºå¯å¤åˆ¶çš„é“¾æ¥ + å¤åˆ¶æŒ‰é’® -->
                <div class="input-group my-3">
                    <input type="text" class="form-control" id="share-link-input" value="" readonly>
                    <div class="input-group-append">
                        <button class="btn btn-info" type="button" onclick="copyLinkManually()">æ‰‹åŠ¨å¤åˆ¶</button>
                    </div>
                </div>

                <!-- è‡ªåŠ¨å¤åˆ¶ & æ‰‹åŠ¨å¤åˆ¶åçš„æç¤º -->
                <div id="copy-success" class="copy-success">åˆ†äº«é“¾æ¥å·²ç»å¤åˆ¶ï¼</div>

                <p>You can save this picture or scan the QR code to share it.</p>
                <div id="final-image-container"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal">close</button>
            </div>
        </div>
    </div>
</div>

<!-- About Modal -->
<div class="modal fade" id="about-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">About</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <h3>å…³äº CodeMark </h3>
                <hr>
                <p>ä½ å¯ä»¥åœ¨æ­¤é¡µé¢è¿›è¡Œ Python ç¼–å†™å’Œä»£ç åˆ†äº«</p>
                <p>æˆ‘ä»¬æ·»åŠ äº†å¯¹ micropipã€NumPy å’Œ Pandas çš„æ”¯æŒã€‚</p>
                <p>ç¥æ‚¨æ¢ç´¢ CodeMark æ„‰å¿«ï¼</p>
                <p>å¯¹äºæƒ³è¦åˆ¶å®šåŒ–æˆ–é«˜æ ¡åˆä½œï¼Œå¯ä»¥æ·»åŠ æ­¤å¾®ä¿¡ï¼šJiabcdefh</p>
                <img src="{{ url_for('static', filename='/images/Jiabcdefh.JPG') }}" alt="å¾®ä¿¡ï¼šJiabcdefh"
                     style="zoom:25%;">
                <br>
                <a href="https://github.com/AndersonHJB/">Github</a>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal">close</button>
            </div>
        </div>
    </div>
</div>

<!-- è‡ªå®šä¹‰å³é”®èœå• -->
<div id="custom-context-menu">
    <ul>
        <li onclick="formatCode()">ä»£ç æ ¼å¼åŒ–</li>
        <li onclick="run()">è¿è¡Œä»£ç </li>
        <li onclick="screenshotAndDownload()">æˆªå›¾å¹¶ä¸‹è½½</li>
        <li onclick="copyAllCode()">å¤åˆ¶æ‰€æœ‰ä»£ç </li>
        <li onclick="pasteCode()">ç²˜è´´åˆ°ç¼–è¾‘å™¨</li>
        <li onclick="copyShareLinkInMenu()">å¤åˆ¶åˆ†äº«é“¾æ¥</li>
    </ul>
</div>

<!-- ================== ä»£ç ç¼–è¾‘å™¨ç›¸å…³ ================== -->
<!-- æ ¸å¿ƒï¼šè¦ç¡®ä¿å¼•å…¥ ext-language_tools.js æ‰å¯ä½¿ç”¨è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ -->
<script src="{{ url_for('static', filename='js/ace/ace.js') }}" type="text/javascript"></script>
<script src="{{ url_for('static', filename='js/ace/ext-language_tools.js') }}" type="text/javascript"></script>
<script src="{{ url_for('static', filename='js/ace/mode-python3.js') }}" type="text/javascript"></script>
<script src="{{ url_for('static', filename='js/FileSaver.min.js') }}" type="text/javascript"></script>
<script src="{{ url_for('static', filename='js/ace/snippets/python.js') }}" type="text/javascript"></script>

<!-- ç¬¬ä¸‰æ–¹åº“ -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.18/dist/js/bootstrap-select.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>

<script type="text/javascript">
    // é˜²æ­¢æµè§ˆå™¨å‰è¿›/åé€€çš„ç¼“å­˜
    window.addEventListener("pageshow", function (event) {
        // å½“é¡µé¢ä»ç¼“å­˜ä¸­åŠ è½½ï¼ˆå‰è¿› / åé€€ï¼‰æ—¶ï¼Œæ‰§è¡Œåˆ·æ–°
        if (event.persisted
            || (typeof window.performance !== "undefined" && window.performance.navigation.type === 2)) {
            window.location.reload();
        }
    });

    // å…¨å±€ pyodide å¯¹è±¡
    let pyodide = null;

    // é¡µé¢åŠ è½½æ—¶ï¼Œåˆå§‹åŒ– Pyodide å’Œç¼–è¾‘å™¨
    window.addEventListener("load", async function () {
        // åŠ è½½ Pyodide åŠå¸¸ç”¨åŒ…
        await loadPyodideAndPackages();

        // Initialize ace editor
        ace.config.set("basePath", "static/js/ace/");
        window.editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/python");

        // ======= å…³é”®ï¼šæ‰“å¼€è‡ªåŠ¨è¡¥å…¨åŠç›¸å…³åŠŸèƒ½ =======
        editor.setOptions({
            fontSize: "20pt",
            enableBasicAutocompletion: true,     // å¯ç”¨åŸºæœ¬ä»£ç æç¤º
            enableLiveAutocompletion: true,      // å¯ç”¨å®æ—¶è‡ªåŠ¨è¡¥å…¨
            enableSnippets: true                 // å¯ç”¨ä»£ç ç‰‡æ®µ
        });
        // =======================================

        // Initialize bootstrap-select
        $('.selectpicker').selectpicker({
            style: 'btn-dark',
            size: 10
        });

        // Set initial theme
        $('#theme-selector').selectpicker('val', 'monokai');

        // Theme change handler
        $('#theme-selector').on('changed.bs.select', function (e) {
            let selectedTheme = $(this).val();
            window.editor.setTheme("ace/theme/" + selectedTheme);
        });

        // Custom keyboard shortcuts
        editor.commands.addCommand({
            name: 'duplicateLine',
            bindKey: {win: 'Ctrl-D', mac: 'Command-D'},
            exec: function (editor) {
                // è°ƒç”¨ Ace å†…ç½®å‘½ä»¤ copylinesdown
                editor.execCommand("copylinesdown");
            }
        });

        // Ctrl/Command + Bï¼šç›´æ¥æ‰§è¡Œä»£ç 
        editor.commands.addCommand({
            name: 'runCode',
            bindKey: {win: 'Ctrl-B', mac: 'Command-B'},
            exec: function () {
                run();
            }
        });
        // ========== è‡ªå®šä¹‰å¿«æ·é”®ç»“æŸ ==========

        // å¦‚æœåç«¯ä¼ æ¥äº† server_pre_codeï¼Œåˆ™ç”¨å®ƒæ¥å¡«å……ç¼–è¾‘å™¨
        if (server_pre_code) {
            editor.setValue(server_pre_code, -1);
        } else {
            // å¦åˆ™ä½¿ç”¨é»˜è®¤ç¤ºä¾‹
            let defaultMsg = "# -*- coding: utf-8 -*-\n# @Time    : 2024/11/16 09:07\n# @Author  : AIæ‚¦åˆ›\n# @FileName: app.py\n# @Software: CodeMark\n# @Blog    ï¼šhttps://bornforthis.cn/\n"
            editor.setValue(defaultMsg + '# æ¬¢è¿ğŸ‘ä½¿ç”¨ CodeMarkâœ¨âœ¨âœ¨\n# æ­¤ç¼–è¾‘å™¨ä½ å¯ä»¥ç¼–è¾‘å’Œåˆ†äº«ä»£ç !\n# PS:æ³¨é‡Šéƒ¨åˆ†ä½ å¯ä»¥ä¿ç•™æˆ–è€…åˆ é™¤\n', -1);
        }
    });

    // åŠ è½½ Pyodideï¼Œå¹¶é¢„å…ˆåŠ è½½ä¸€äº›å¸¸ç”¨åŒ…
    async function loadPyodideAndPackages() {
        // åŠ è½½ pyodide
        pyodide = await loadPyodide({
            indexURL: "https://cdn.jsdelivr.net/pyodide/v0.26.4/full/"
        });
        // é€šè¿‡å†…ç½®çš„ loadPackage æ–¹å¼åŠ è½½ micropipã€numpyã€pandas ç­‰
        await pyodide.loadPackage(["micropip", "numpy", "pandas"]);

        // è¿™é‡Œç”¨ micropip å®‰è£… autopep8ï¼Œç”¨äºä»£ç æ ¼å¼åŒ–
        await pyodide.runPythonAsync(`
import micropip
await micropip.install("autopep8")
`);
        // åœ¨æ§åˆ¶å°æç¤ºä¸€ä¸‹
        document.getElementById("console").value = "Python loaded!\n";
    }

    // æ‰§è¡Œ Python ä»£ç 
    async function run() {
        let code = window.editor.getValue();
        // æ¸…ç©º console
        let consoleElement = document.getElementById("console");
        consoleElement.value = "";

        // é‡å®šå‘ stdout / stderr
        try {
            await pyodide.runPythonAsync(`
import sys, builtins
import js

class PyodideIO:
    def write(self, data):
        # æŠŠ stdout / stderr å†™åˆ°å‰ç«¯ console
        if data.strip() != '':
            js_console_write(data)
        return len(data)

def js_console_write(text):
    import js
    textarea = js.document.getElementById("console")
    textarea.value += text + "\\n"

def py_input(prompt=''):
    # å¼¹çª—è·å–ç”¨æˆ·è¾“å…¥
    return js.window.prompt(prompt)

# å°†è‡ªå®šä¹‰çš„ py_input æ›¿æ¢å†…ç½® input
builtins.input = py_input
sys.stdout = PyodideIO()
sys.stderr = PyodideIO()

# æ‰§è¡Œç”¨æˆ·ç¼–è¾‘å™¨çš„ä»£ç 
${code}
            `);
        } catch (err) {
            // å¦‚æœæœ‰å¼‚å¸¸ï¼Œæ‰“å°åˆ° console
            consoleElement.value += String(err) + "\n";
        }
    }

    // æ‰“å¼€æ–‡ä»¶
    function performClick(elemId) {
        const elem = document.getElementById(elemId);
        if (elem) {
            elem.click();
        }
    }

    // è¯»æ–‡ä»¶
    function readSingleFile(e) {
        let file = e.target.files[0];
        if (!file) {
            return;
        }
        let reader = new FileReader();
        reader.onload = function (e) {
            window.editor.setValue(e.target.result, -1);
        };
        reader.readAsText(file);
    }

    // å›åˆ°é¦–é¡µ
    function home() {
        window.location.href = "/";
    }

    // ä¿å­˜ä¸ºæ–‡ä»¶
    function save() {
        let code = window.editor.getValue();
        let blob = new Blob([code], {type: "text/plain;charset=utf-8"});
        saveAs(blob, "bornforthis_code.py");
    }

    // åˆ†äº«åŠŸèƒ½ï¼šä¸Šä¼ ä»£ç åˆ°åç«¯ï¼Œè¿”å›ä¸€ä¸ªå¯åˆ†äº«çš„é“¾æ¥
    function share() {
        let code = window.editor.getValue();
        $.ajax({
            type: 'post',
            url: '/upload_code',
            dataType: 'json',
            data: {
                code: code,
                language: 'python',
                template: 'editor'   // å‘Šè¯‰åç«¯æ­¤åˆ†äº«æ¥è‡ª editorï¼Œå¯æ‰§è¡Œ Python
            },
            success: function (d) {
                // åç«¯è¿”å› share_linkï¼Œä¾‹å¦‚ http://127.0.0.1:5000/share/xxxx
                let shareLink = d.share_link;

                // 1. ç”ŸæˆäºŒç»´ç ï¼ˆå†…å®¹æ˜¯ shareLinkï¼‰
                $('#qrcode').empty();
                $('#qrcode').qrcode({
                    text: shareLink,
                    width: 200,
                    height: 200
                });

                // 2. æ›´æ–°å¼¹çª—æ ‡é¢˜ä¸­çš„å¯ç‚¹å‡»é“¾æ¥
                $('.modal-title').html(
                    'Code linkï¼š<a href="' + shareLink + '" target="_blank">' + shareLink + '</a>'
                );
                // 2. æŠŠåˆ†äº«é“¾æ¥æ”¾å…¥è¾“å…¥æ¡†
                $('#share-link-input').val(shareLink);

                // 3. è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿
                copyToClipboard(shareLink);

                // å¦‚æœæƒ³æŠŠäºŒç»´ç å åŠ åˆ°ç¼–è¾‘å™¨æˆªå›¾ï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹é€»è¾‘ï¼š
                let qrcodeCanvas = $('#qrcode canvas')[0];
                let qrcode_src = qrcodeCanvas.toDataURL('image/png');

                // æ–°å»ºä¸€ä¸ªå®¹å™¨æ¥æ”¾æœ€ç»ˆåˆæˆçš„å›¾ç‰‡ï¼ˆé¿å…è¦†ç›–åŸäºŒç»´ç ï¼‰
                let existingFinalImageContainer = document.getElementById("final-image-container");
                if (existingFinalImageContainer) {
                    existingFinalImageContainer.remove();
                }
                let finalImageContainer = document.createElement("div");
                finalImageContainer.id = "final-image-container";
                finalImageContainer.style.marginTop = "20px";
                document.getElementById("qrcode").parentNode.appendChild(finalImageContainer);

                // æˆªå–ç¼–è¾‘å™¨åŒºåŸŸï¼Œå¹¶æŠŠäºŒç»´ç ç»˜åˆ¶åˆ°æˆªå›¾çš„å³ä¸Šè§’ï¼Œç„¶åå†æ”¾åˆ°æ–°å®¹å™¨
                html2canvas(document.querySelector("#editor")).then(canvas => {
                    let ctx = canvas.getContext('2d');
                    let img = new Image();
                    img.src = qrcode_src;
                    img.onload = function () {
                        // åœ¨ç¼–è¾‘å™¨æˆªå›¾ä¸Šå åŠ äºŒç»´ç ï¼Œç¼©å°åˆ° 120x120
                        let qrSize = 120;
                        ctx.drawImage(img, canvas.width - qrSize - 10, 10, qrSize, qrSize);

                        // æ˜¾ç¤ºåˆæˆåçš„æœ€ç»ˆå›¾ç‰‡
                        let finalImgElement = document.createElement("img");
                        finalImgElement.src = canvas.toDataURL('image/png');
                        finalImgElement.style.maxWidth = "90%";
                        finalImageContainer.appendChild(finalImgElement);
                    }
                });

                // 4. æ˜¾ç¤ºåˆ†äº«å¼¹çª—
                $('#share-modal').modal('show');
            }
        });
    }

    // è‡ªåŠ¨å¤åˆ¶ä¸æç¤º
    function copyToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
            // å¦‚æœæ”¯æŒå¼‚æ­¥ clipboard API
            navigator.clipboard.writeText(text).then(function () {
                showCopySuccess();
            });
        } else {
            // å…¼å®¹ä¸æ”¯æŒå¼‚æ­¥ clipboard API çš„æƒ…å†µ
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showCopySuccess();
        }
    }

    // æ‰‹åŠ¨ç‚¹å‡»å¤åˆ¶
    function copyLinkManually() {
        let shareLink = document.getElementById("share-link-input").value;
        copyToClipboard(shareLink);
    }

    // æ˜¾ç¤ºâ€œåˆ†äº«é“¾æ¥å·²ç»å¤åˆ¶ï¼â€çš„æç¤ºåŠ¨ç”»
    function showCopySuccess() {
        let copyMsg = document.getElementById("copy-success");
        // é‡ç½®åŠ¨ç”»ï¼Œç”¨äºå¤šæ¬¡è§¦å‘
        copyMsg.style.display = "block";
        copyMsg.style.animation = "none";
        void copyMsg.offsetWidth; // è§¦å‘é‡ç»˜ï¼Œè®©æµè§ˆå™¨æ„è¯†åˆ°éœ€è¦é‡æ–°æ’­æ”¾åŠ¨ç”»
        copyMsg.style.animation = null;

        // 2ç§’åéšè—
        setTimeout(() => {
            copyMsg.style.display = "none";
        }, 2000);
    }

    // ========== è‡ªå®šä¹‰å³é”®èœå•ç›¸å…³ ==========
    document.addEventListener('contextmenu', function (e) {
        e.preventDefault();
        let menu = document.getElementById("custom-context-menu");
        if (!menu) return;

        menu.style.display = 'block';
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
    });

    // å·¦é”®ç‚¹å‡»åéšè—èœå•
    document.addEventListener('click', function () {
        let menu = document.getElementById("custom-context-menu");
        if (menu) menu.style.display = 'none';
    });

    // æ ¼å¼åŒ–ä»£ç ï¼ˆautopep8ï¼‰
    async function formatCode() {
        let code = window.editor.getValue();
        try {
            let formattedCode = await pyodide.runPythonAsync(`
import autopep8
code = """${escapeForPython(code)}"""
autopep8.fix_code(code)
            `);
            window.editor.setValue(formattedCode, -1);
        } catch (e) {
            alert("æ ¼å¼åŒ–å¤±è´¥: " + e);
        }
    }

    // æˆªå›¾å¹¶ä¸‹è½½
    function screenshotAndDownload() {
        let code = window.editor.getValue();

        // åˆ›å»ºä¸€ä¸ªéšè—å®¹å™¨
        let hiddenContainer = document.createElement('div');
        hiddenContainer.style.position = 'fixed';
        hiddenContainer.style.top = '-9999px';
        hiddenContainer.style.left = '0';
        hiddenContainer.style.padding = '20px';
        hiddenContainer.style.backgroundColor = '#2f3129';
        hiddenContainer.style.color = '#fff';
        hiddenContainer.style.fontFamily = 'Monaco, Menlo, Ubuntu Mono, Consolas, source-code-pro, monospace';
        hiddenContainer.style.fontSize = '16px';
        hiddenContainer.style.lineHeight = '1.5';
        hiddenContainer.style.whiteSpace = 'pre';
        hiddenContainer.id = 'hidden-screenshot-container';

        hiddenContainer.textContent = code;
        document.body.appendChild(hiddenContainer);

        // å¯¹è¿™ä¸ªéšè—å®¹å™¨è¿›è¡Œæˆªå›¾
        html2canvas(hiddenContainer).then(canvas => {
            canvas.toBlob(function (blob) {
                saveAs(blob, "code_screenshot.png");
                // æˆªå›¾å®Œæˆåç§»é™¤éšè—å®¹å™¨
                document.body.removeChild(hiddenContainer);
            });
        });
    }

    // å¤åˆ¶ç¼–è¾‘å™¨æ‰€æœ‰ä»£ç 
    function copyAllCode() {
        let code = window.editor.getValue();
        copyToClipboard(code);
    }

    // å°è¯•ç²˜è´´åˆ°ç¼–è¾‘å™¨
    function pasteCode() {
        if (navigator.clipboard && navigator.clipboard.readText) {
            navigator.clipboard.readText().then(text => {
                window.editor.insert(text);
            }).catch(err => {
                alert("æ— æ³•è¯»å–å‰ªè´´æ¿ï¼š" + err);
            });
        } else {
            alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒç›´æ¥è¯»å–å‰ªè´´æ¿ã€‚");
        }
    }

    // å¤åˆ¶åˆ†äº«é“¾æ¥ï¼ˆåœ¨å³é”®èœå•ä¸­ä½¿ç”¨ï¼‰
    function copyShareLinkInMenu() {
        let shareLink = document.getElementById("share-link-input").value;
        if (!shareLink) {
            alert("æš‚æ— å¯åˆ†äº«çš„é“¾æ¥ï¼Œè¯·å…ˆç‚¹å‡»åˆ†äº«æŒ‰é’®ç”Ÿæˆã€‚");
            return;
        }
        copyToClipboard(shareLink);
    }

    // ä¸ºé¿å…å¤šè¡Œå­—ç¬¦ä¸²åœ¨ Python ä¸­å‡ºç°æ„å¤–ï¼Œéœ€è¦åšè½¬ä¹‰
    function escapeForPython(str) {
        // å°†åæ–œæ ä¸åŒå¼•å·è¿›è¡Œè½¬ä¹‰
        return str.replace(/\\/g, '\\\\').replace(/\"/g, '\\"');
    }

    // ç›‘å¬æ–‡ä»¶é€‰æ‹©
    document.getElementById('file-input').addEventListener('change', readSingleFile, false);
</script>
</body>
</html>