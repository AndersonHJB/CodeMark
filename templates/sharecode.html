<!DOCTYPE html>
<html lang="en">
<head>
    <title>Pyodide Example</title>
    <meta name="keywords" content="Python, JavaScript, Pyodide">
    <meta name="description" content="">
    <link href="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/bootstrap-select/1.13.10/css/bootstrap-select.min.css" rel="stylesheet">
    <style type="text/css" media="screen">
        .ace_editor .ace_content span,
        .ace_editor .ace_content .ace_line {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace!important;
        }

        img {
            max-width: 100%;
        }

        .btn-area {
            height: 56px;
            background-color: #2f3129;
        }

        .btn-area button {
            float: left;
            color: #fff;
            border-radius: 0;
            border-width: 0;
            height: 100%;
            width: 80px;
        }

        #run {
            float: left;
            background-color: #a7c336;
            color: #fff;
            border-radius: 0;
            border-width: 0;
            height: 100%;
            width: 80px;
        }

        #save {
            background-color: #6dddf2;
        }

        #open {
            background-color: #f53855;
        }

        #share {
            background-color: #a7c336;
        }

        .help-link-container a {
            color: #fff;
        }

        .choose-container {
            color: #fff;
            padding-left: 5px;
            padding-right: 5px;
            display: flex;
            display: -webkit-flex;
            align-items: center;
        }

        .theme-choose {
            color: #fff;
            padding-left: 5px;
            padding-right: 5px;
            display: flex;
            display: -webkit-flex;
            align-items: center;
        }

        .code-container {
            padding-left: 0;
            padding-right: 0;
        }

        #editor {
            padding-right: 0;
            padding-left: 0;
        }

        .console {
            width: 100%;
            height: 100%;
            background-color: #000;
            color: #FFF;
            font-size: 20px;
            font-weight: 700;
            border-width: 0;
            font-family: 'Monaco', 'Consolas', serif;
            padding: 8px 8px;
            white-space: pre;
            overflow-x: auto;
            overflow-y: auto;
            resize: none;
        }

        .modal-dialog {
            max-width: 90%;
        }

        html, body {
            height: 100%;
        }

        body {
            overflow: hidden;
        }
    </style>
</head>

<body>
<div class="container-fluid">
    <div class="row">
        <!-- 代码编辑区 -->
        <div class="col-sm-8 code-container">
            <div id="editor"></div>
        </div>
        <!-- 控制台输出区 -->
        <div class="col-md-4 pl-0 pr-0">
            <textarea id="console" class="console" autocomplete="off">Initializing Pyodide...</textarea>
        </div>
    </div>

    <!-- 按钮区域 -->
    <div class="row btn-area">
        <button id="run" onclick="run()">> run</button>
        <button id="save" onclick="save()">save</button>
        <button id="open" onclick="performClick('file-input')">open</button>
        <button id="share" onclick="share()">share</button>
        <div class="choose-container theme-selector-container">
            <span class="ml-2 mr-2">Theme: </span>
            <select id="theme-selector" size="1" class="selectpicker"
                    data-live-search="true" data-style="btn-success" data-width="100px">
                <option value="ambiance">ambiance</option>
                <option value="chaos">chaos</option>
                <option value="chrome">chrome</option>
                <option value="clouds">clouds</option>
                <option value="clouds_midnight">clouds_midnight</option>
                <option value="cobalt">cobalt</option>
                <option value="crimson_editor">crimson_editor</option>
                <option value="dawn">dawn</option>
                <option value="dracula">dracula</option>
                <option value="dreamweaver">dreamweaver</option>
                <option value="eclipse">eclipse</option>
                <option value="github">github</option>
                <option value="gob">gob</option>
                <option value="gruvbox">gruvbox</option>
                <option value="idle_fingers">idle_fingers</option>
                <option value="iplastic">iplastic</option>
                <option value="katzenmilch">katzenmilch</option>
                <option value="kr_theme">kr_theme</option>
                <option value="kuroir">kuroir</option>
                <option value="merbivore">merbivore</option>
                <option value="merbivore_soft">merbivore_soft</option>
                <option value="monokai">monokai</option>
                <option value="mono_industrial">mono_industrial</option>
                <option value="pastel_on_dark">pastel_on_dark</option>
                <option value="solarized_dark">solarized_dark</option>
                <option value="solarized_light">solarized_light</option>
                <option value="sqlserver">sqlserver</option>
                <option value="terminal">terminal</option>
                <option value="textmate">textmate</option>
                <option value="tomorrow">tomorrow</option>
                <option value="tomorrow_night">tomorrow_night</option>
                <option value="tomorrow_night_blue">tomorrow_night_blue</option>
                <option value="tomorrow_night_bright">tomorrow_night_bright</option>
                <option value="tomorrow_night_eighties">tomorrow_night_eighties</option>
                <option value="twilight">twilight</option>
                <option value="vibrant_ink">vibrant_ink</option>
                <option value="xcode">xcode</option>
            </select>
        </div>
        <div class="help-link-container my-auto">
            <a id="about" onclick="$('#about-modal').modal('show')" href="#">About</a>
        </div>
        <input id="file-input" type="file" style="position:fixed;top:-1000px;"/>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="share-modal" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Share your code</h5>
                <button type="button" class="close" data-dismiss="modal"
                        aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <div id="qrcode" style="margin-left:auto; margin-right:auto; margin-bottom: 20px;"></div>
                <p>You can save this picture or scan the QR code to share it.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" type="button" data-dismiss="modal">close</button>
            </div>
        </div>
    </div>
</div>

<!-- About Modal -->
<div class="modal fade" id="about-modal" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width: 100%">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">About</h5>
                <button type="button" class="close" data-dismiss="modal"
                        aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <h3>About</h3>
                <hr>
                <p>This page demonstrates running Python in the browser with Pyodide.</p>
                <p>We have added support for micropip, NumPy, and Pandas.</p>
                <p>Enjoy exploring Pyodide!</p>
                <a href="https://github.com/AndersonHJB/">Github</a>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal">close</button>
            </div>
        </div>
    </div>
</div>

<!-- ================== 代码编辑器相关 ================== -->
<script src="static/js/ace/ace.js" type="text/javascript"></script>
<script src="static/js/ace/ext-language_tools.js" type="text/javascript"></script>
<script src="static/js/ace/mode-python3.js" type="text/javascript"></script>

<!-- 第三方库 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script type="text/javascript" src="static/js/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.8/umd/popper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.18/js/bootstrap-select.min.js"></script>

<!-- Pyodide -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>

<script type="text/javascript">
    // 全局 pyodide 对象
    let pyodide = null;

    // 页面加载时，初始化 Pyodide 和编辑器
    window.addEventListener("load", async function () {
        // 加载 Pyodide 及常用包
        await loadPyodideAndPackages();

        // 设置编辑器高度
        document.getElementById("editor").style.height = (window.innerHeight - 56) + "px";
        // 初始化 bootstrap-select 的默认选择
        $('#theme-selector').selectpicker('val', 'monokai');
        // 初始化 ace
        ace.config.set("basePath", "static/js/ace/");
        window.editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/python");
        editor.setOptions({ fontSize: "20pt" });
        // ========== 绑定自定义快捷键 ==========
        // Ctrl/Command + D：复制当前行
        editor.commands.addCommand({
            name: 'duplicateLine',
            bindKey: { win: 'Ctrl-D', mac: 'Command-D' },
            exec: function (editor) {
                // 调用 Ace 内置命令 copylinesdown
                editor.execCommand("copylinesdown");
            }
        });

        // Ctrl/Command + B：直接执行代码
        editor.commands.addCommand({
            name: 'runCode',
            bindKey: { win: 'Ctrl-B', mac: 'Command-B' },
            exec: function () {
                run();
            }
        });
        // ========== 自定义快捷键结束 ==========

        // 初始化示例代码
        editor.setValue("# Write your Python code here\nprint('Hello from Pyodide!')");
    });

    // 加载 Pyodide，并预先加载一些常用包
    async function loadPyodideAndPackages() {
        // 加载 pyodide
        pyodide = await loadPyodide({
            indexURL: "https://cdn.jsdelivr.net/pyodide/v0.26.4/full/"
        });
        // 通过内置的 loadPackage 方式加载 micropip、numpy、pandas 等
        await pyodide.loadPackage(["micropip", "numpy", "pandas"]);

        // 在控制台提示一下
        document.getElementById("console").value = "Pyodide and packages loaded!\n";
    }

    // 执行 Python 代码
    async function run() {
        let code = window.editor.getValue();
        // 清空 console
        let consoleElement = document.getElementById("console");
        consoleElement.value = "";

        // 重定向 stdout / stderr
        try {
            await pyodide.runPythonAsync(`
import sys, builtins
import js

class PyodideIO:
    def write(self, data):
        # 把 stdout / stderr 写到前端 console
        if data.strip() != '':
            js_console_write(data)
        return len(data)

def js_console_write(text):
    import js
    textarea = js.document.getElementById("console")
    textarea.value += text + "\\n"

def py_input(prompt=''):
    # 弹窗获取用户输入
    return js.window.prompt(prompt)

# 将自定义的 py_input 替换内置 input
builtins.input = py_input
sys.stdout = PyodideIO()
sys.stderr = PyodideIO()

# 执行用户编辑器的代码
${code}
            `);
        } catch (err) {
            // 如果有异常，打印到 console
            consoleElement.value += String(err) + "\n";
        }
    }

    // 打开文件
    function performClick(elemId) {
        const elem = document.getElementById(elemId);
        if (elem) {
            const evt = new MouseEvent("click", {
                bubbles: true,
                cancelable: false,
                view: window
            });
            elem.dispatchEvent(evt);
        }
    }

    // 读文件
    function readSingleFile(e) {
        let file = e.target.files[0];
        if (!file) {
            return;
        }
        let reader = new FileReader();
        reader.onload = function (e) {
            let contents = e.target.result;
            let editor = window.ace.edit("editor");
            editor.setValue(contents);
        };
        reader.readAsText(file);
    }

    // 保存为文件
    function save() {
        let code = window.editor.getValue();
        let blob = new Blob([code], {type: "text/plain;charset=utf-8"});
        saveAs(blob, "pyodide_code.py");
    }

    // 分享功能（演示用，需要自行实现上传接口）
    function share() {
        let code = window.editor.getValue();
        // 这里的上传接口，需要你自己实现
        $.ajax({
            type: 'post',
            url: 'upload_code',
            dataType: 'json',
            data: {code: code, language: 'python'},
            success: function (d) {
                let codeUrl = window.location.origin + "/?id=" + d.project_id;
                jQuery('#qrcode').qrcode(codeUrl);
                $('.modal-title').html('Code link：<a href="' + codeUrl + '">' + codeUrl + '</a>');
                let canvas = $('#qrcode canvas')[0];
                let qrcode_src = canvas.toDataURL('image/jpg');
                $('#qrcode').html('');

                html2canvas(document.querySelector("#editor")).then(canvas => {
                    let ctx = canvas.getContext('2d');
                    let img = new Image();
                    img.src = qrcode_src;
                    img.onload = function () {
                        ctx.globalAlpha = 1;
                        ctx.drawImage(img, canvas.width - img.width - 10, 10);
                        let imgElement = document.createElement("img");
                        imgElement.src = canvas.toDataURL('image/png');
                        document.getElementById("qrcode").appendChild(imgElement);
                    }
                });
                $('#share-modal').modal('show')
            }
        })
    }

    // 监听文件选择
    document.getElementById('file-input').addEventListener('change', readSingleFile, false);

    // 主题选择监听
    $('#theme-selector').on('changed.bs.select', function (e, clickedIndex) {
        if (clickedIndex !== null) {
            let theme = $('#theme-selector option')[clickedIndex].getAttribute('value');
            window.editor.setTheme("ace/theme/" + theme);
        }
    });
</script>
</body>
</html>