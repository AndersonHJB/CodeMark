<!DOCTYPE html>
<html lang="en">
<head>
    <title>p5py with Pyodide</title>
    <meta name="keywords" content="Python, JavaScript, p5.js, Pyodide">
    <meta name="description" content="">
    <!-- 样式依旧引用 Bootstrap 及其依赖 -->
    <link href="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/bootstrap-select/1.13.10/css/bootstrap-select.min.css" rel="stylesheet">
    <style type="text/css" media="screen">
        .ace_editor .ace_content span, .ace_editor .ace_content .ace_line {
          font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace!important;
        }
        img {
            max-width: 100%;
        }
        .btn-area {
            height: 56px;
            background-color: #2f3129;
        }
        .btn-area button {
            float: left;
            color: #fff;
            border-radius: 0;
            border-width: 0;
            height: 100%;
            width: 80px;
        }
        #run {
            float: left;
            background-color: #a7c336;
            color: #fff;
            border-radius: 0;
            border-width: 0;
            height: 100%;
            width: 80px;
        }
        #save {
            background-color: #6dddf2;
        }
        #open {
            background-color: #f53855;
        }
        #share {
            background-color: #a7c336;
        }
        .help-link-container a {
          color: #fff;
          cursor: pointer;
        }
        .choose-container {
            color: #fff;
            padding-left: 5px;
            padding-right: 5px;
            display:flex;
            display: -webkit-flex;
            align-items:center;
        }
        .theme-choose {
          color: #fff;
          padding-left: 5px;
          padding-right: 5px;
          display:flex;
          display: -webkit-flex;
          align-items:center;
        }
        .code-container {
            padding-left: 0;
            padding-right: 0;
        }
        #editor {
            padding-right:0;
            padding-left: 0;
        }
        .console {
          width: 100%;
          height: 100%;
          background-color: #000;
          color: #FFF;
          font-size: 20px;
          font-weight: 700;
          border-width: 0;
          font-family: 'Monaco', 'Consolas';
          padding: 8px 8px;
        }
        .modal-dialog {
          max-width: 90%;
        }
        html, body {
          height: 100%;
        }
        body {
          overflow: hidden;
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <!-- 左侧代码编辑器 -->
        <div class="col-sm-8 code-container">
            <div id="editor"></div>
        </div>
        <!-- 右侧控制台 -->
        <div class="col-md-4 pl-0 pr-0">
          <textarea id="console" class="console" autocomplete="off">Initializing Pyodide...</textarea>
        </div>
    </div>
    <!-- 底部按钮区域 -->
    <div class="row btn-area">
        <button id="run" onclick="run()">> run</button>
        <button id="save" onclick="saveCode()">save</button>
        <button id="open" onclick="performClick('file-input')">open</button>
        <button id="share" onclick="shareCode()">share</button>
        <div class="choose-container theme-selector-container">
            <span class="ml-2 mr-2">Theme: </span>
            <select id="theme-selector" size="1" class="selectpicker"
                    data-live-search="true" data-style="btn-success" data-width="100px">
                <option value="ambiance">ambiance</option>
                <option value="chaos">chaos</option>
                <option value="chrome">chrome</option>
                <option value="clouds">clouds</option>
                <option value="clouds_midnight">clouds_midnight</option>
                <option value="cobalt">cobalt</option>
                <option value="crimson_editor">crimson_editor</option>
                <option value="dawn">dawn</option>
                <option value="dracula">dracula</option>
                <option value="dreamweaver">dreamweaver</option>
                <option value="eclipse">eclipse</option>
                <option value="github">github</option>
                <option value="gob">gob</option>
                <option value="gruvbox">gruvbox</option>
                <option value="idle_fingers">idle_fingers</option>
                <option value="iplastic">iplastic</option>
                <option value="katzenmilch">katzenmilch</option>
                <option value="kr_theme">kr_theme</option>
                <option value="kuroir">kuroir</option>
                <option value="merbivore">merbivore</option>
                <option value="merbivore_soft">merbivore_soft</option>
                <option value="monokai" selected>monokai</option>
                <option value="mono_industrial">mono_industrial</option>
                <option value="pastel_on_dark">pastel_on_dark</option>
                <option value="solarized_dark">solarized_dark</option>
                <option value="solarized_light">solarized_light</option>
                <option value="sqlserver">sqlserver</option>
                <option value="terminal">terminal</option>
                <option value="textmate">textmate</option>
                <option value="tomorrow">tomorrow</option>
                <option value="tomorrow_night">tomorrow_night</option>
                <option value="tomorrow_night_blue">tomorrow_night_blue</option>
                <option value="tomorrow_night_bright">tomorrow_night_bright</option>
                <option value="tomorrow_night_eighties">tomorrow_night_eighties</option>
                <option value="twilight">twilight</option>
                <option value="vibrant_ink">vibrant_ink</option>
                <option value="xcode">xcode</option>
            </select>
        </div>
        <div class="help-link-container my-auto ml-3">
          <a id="about-link">About p5py</a>
        </div>
        <!-- 隐藏的文件选择器 -->
        <input id="file-input" type="file" style="position:fixed;top:-1000px;"/>
    </div>
</div>

<!-- share弹窗 -->
<div class="modal fade" id="share-modal" tabindex="-1" role="dialog" aria-labelledby="shareModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Share your code</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body text-center">
        <div id="qrcode" style="margin-left:auto; margin-right:auto; margin-bottom: 20px;"></div>
        <p>You can save this picture or scan the QR code to share it.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-default" type="button" data-dismiss="modal">close</button>
      </div>
    </div>
  </div>
</div>

<!-- canvas预览弹窗 -->
<div class="modal fade" id="canvas-modal" tabindex="-1" role="dialog" aria-labelledby="canvasModalLabel" aria-hidden="true">
  <div class="modal-dialog" style="width: 100%">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Preview</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body text-center">
        <div id="p5Canvas"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-dismiss="modal">close</button>
      </div>
    </div>
  </div>
</div>

<!-- about弹窗 -->
<div class="modal fade" id="about-modal" tabindex="-1" role="dialog" aria-labelledby="aboutModalLabel" aria-hidden="true">
  <div class="modal-dialog" style="width: 100%">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">About</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body text-center">
        <h3>About p5py</h3>
        <hr>
        <p>P5py.com lets you write p5.js programs in python, now powered by Pyodide.</p>
        <p>Looking forward to your feedback!</p>
        <a href="https://github.com/AndersonBY/p5py">github link</a>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-dismiss="modal">close</button>
      </div>
    </div>
  </div>
</div>

<!-- 依赖脚本：Ace编辑器、jQuery、Bootstrap、二维码、html2canvas 等 -->
<!-- 你也可改用其他 CDN，只需保证版本对应即可 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.23.1/ace.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.23.1/ext-language_tools.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.23.1/mode-python.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.18/js/bootstrap-select.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.8/umd/popper.min.js"></script>

<!-- 文件保存功能 -->
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<!-- p5.js及相关 -->
<script src="https://cdn.jsdelivr.net/npm/p5@1.5.0/lib/p5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/p5@1.5.0/lib/addons/p5.sound.min.js"></script>

<!-- Pyodide (官方CDN) -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.23.3/full/pyodide.js"></script>

<script>
  let editor;
  let pyodideReady = false;
  let pyodideInstance = null;

  // 异步加载 Pyodide
  async function loadPyodideAndPackages() {
    // 载入 Pyodide
    pyodideInstance = await loadPyodide({
      indexURL : "https://cdn.jsdelivr.net/pyodide/v0.23.3/full/"
    });

    // 如果需要装第三方依赖，可以在这里用 micropip.install()
    // 如：await pyodideInstance.runPythonAsync("import micropip; await micropip.install('package_name')");

    pyodideReady = true;
    console.log("Pyodide is ready.");
    document.getElementById("console").value = "Pyodide loaded.\n";
  }

  window.onload = async function() {
    // 高度设置
    document.getElementById("editor").style.height = String(window.innerHeight - 56) + "px";

    // 初始化下拉
    $('#theme-selector').selectpicker('refresh');

    // 初始化Ace编辑器
    editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/python");
    editor.setOptions({
      fontSize: "20pt",
      enableBasicAutocompletion: true,
      enableLiveAutocompletion: true,
      enableSnippets: true
    });

    // 可以在此预填一些示例代码：
    const defaultCode = [
      "# Try some p5 in Python syntax (just as an example).",
      "# e.g. createCanvas(600, 400) -> draws a 600x400 canvas in the preview modal.",
      "print('Hello, Pyodide + p5!')",
      "",
      "# If you type createCanvas(600, 400), you can see a canvas in the preview modal.",
      ""
    ].join("\\n");

    editor.setValue(defaultCode, -1);

    // 载入 Pyodide
    await loadPyodideAndPackages();

    // About 按钮点击
    document.getElementById("about-link").onclick = function() {
      $('#about-modal').modal('show');
    };
  };

  // 主题切换
  $('#theme-selector').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
      if (clickedIndex !== null) {
          const theme = $('#theme-selector option')[clickedIndex].getAttribute('value');
          editor.setTheme("ace/theme/" + theme);
      }
  });

  // 执行 Python 代码
  async function run() {
    if (!pyodideReady) {
      alert("Pyodide is not ready yet!");
      return;
    }
    const code = editor.getValue();

    // 如果代码中出现 createCanvas 或 background，则打开预览 Modal
    if (code.search('createCanvas') >= 0 || code.search('background') >= 0) {
      $('#canvas-modal').modal('show');
    }

    // 重置控制台
    const consoleArea = document.getElementById("console");
    consoleArea.value = "";

    // 重定向 stdout / stderr
    pyodideInstance.setStdout({
      batched: (text) => {
        consoleArea.value += text;
      }
    });
    pyodideInstance.setStderr({
      batched: (text) => {
        consoleArea.value += text;
      }
    });

    // 在 Pyodide 中执行代码
    try {
      await pyodideInstance.runPythonAsync(code);
    } catch (err) {
      consoleArea.value += `\nError: ${err}\n`;
    }
  }

  // 文件打开
  function performClick(elemId) {
    const elem = document.getElementById(elemId);
    if(elem && document.createEvent) {
      const evt = document.createEvent("MouseEvents");
      evt.initEvent("click", true, false);
      elem.dispatchEvent(evt);
    }
  }
  // 读取文件
  function readSingleFile(e) {
    const file = e.target.files[0];
    if (!file) {
      return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
      const contents = e.target.result;
      editor.setValue(contents, -1);
    };
    reader.readAsText(file);
  }
  // 文件保存
  function saveCode(){
    const code = editor.getValue();
    const blob = new Blob([code], {type: "text/plain;charset=utf-8"});
    saveAs(blob, "p5py.py");
  }
  // 代码分享（占位，留待自行实现）
  function shareCode() {
    // 此处Ajax请求和二维码生成逻辑留给你后续自行实现
    // 下面是占位示例
    const code = editor.getValue();
    console.log("Code to share:", code);

    // 这里可做：向后端上传代码，后端生成分享链接 + 返回 project_id
    // 前端再用 jquery.qrcode 生成二维码
    // 这里仅做占位演示
    const dummyLink = window.location.origin + "/?id=dummy_id_123456";
    $('#qrcode').empty();
    $('#qrcode').qrcode(dummyLink);

    // 显示弹窗
    $('.modal-title').html('Code link：<a href="' + dummyLink + '">' + dummyLink + '</a>');
    $('#share-modal').modal('show');
  }

  // 监听文件选择
  document.getElementById('file-input').addEventListener('change', readSingleFile, false);
</script>
</body>
</html>